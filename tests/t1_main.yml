---
- name: Pre-Test Scenario 1.0 - initialize test docker containers
  hosts: localhost
  roles:
    - role: 'provision_docker'
      provision_docker__inventory:
        - name: 'test_sudo_t1_centos7'
          image: 'tomashavlas/ansible-test:centos7'
          volumes:
            - '/sys/fs/cgroup:/sys/fs/cgroup:ro'
        - name: 'test_sudo_t1_debian8'
          image: 'tomashavlas/ansible-test:debian8'
          volumes:
            - '/sys/fs/cgroup:/sys/fs/cgroup:ro'
  post_tasks:
    - name: Wait for SSH connection to docker containers
      wait_for:
        host: '{{ hostvars[item.name]["ansible_ssh_host"] }}'
        port: 22
        timeout: 30
        connect_timeout: 30
      with_items: '{{ provision_docker__inventory }}'
  tags: [ 'initialize-docker' ]

- name: Test Scenario 1.1 - basic functionality
  hosts: provision_docker__containers
  remote_user: 'root'
  pre_tasks:
    - name: Pre-Test - include OS specific variables
      include_vars: '../vars/{{ ansible_os_family }}.yml'
      tags: [ 'always' ]
    - name: Pre-Test - create configuration drop-ins directory
      file:
        path: '{{ sudo__confd_dir }}'
        state: 'directory'
      changed_when: False
      tags: [ 'pre-test' ]
    - name: Pre-Test - create sample test file
      copy:
        dest: '{{ sudo__confd_dir }}/s1_sample_file'
        src: 'files/acceptance_tests/t1/s1_sample_file'
        owner: 'root'
        group: 'root'
        mode: 0440
      changed_when: False
      tags: [ 'pre-test' ]
  post_tasks:
    - name: Acceptance Test - copy acceptance test files into docker containers
      copy:
        src: 'files/acceptance_tests/'
        dest: '/tmp/acceptance_tests/'
        owner: 'root'
        group: 'root'
        mode: 0440
        directory_mode: 0550
      changed_when: False
      tags: [ 'acceptance-test' ]
    - name: Acceptance Test - verify main configuration file
      shell: 'bash -c "diff <(tail -n +2 {{ sudo__conf_file }}) <(tail -n +2 /tmp/acceptance_tests/t1/s1_sudoers)"'
      changed_when: False
      tags: [ 'acceptance-test' ]
    - name: Acceptance Test - verify drop-in configuration files
      shell: 'bash -c "diff <(tail -n +2 {{ sudo__confd_dir }}/{{ item }}) <(tail -n +2 /tmp/acceptance_tests/t1/{{ item }})"'
      changed_when: False
      with_items:
        - 's1_test_defaults'
        - 's1_test_defaults_mixed'
        - 's1_test_example_playbook_wheel'
        - 's1_test_multiple_values'
        - 's1_test_not_disabled'
        - 's1_test_single_value'
      tags: [ 'acceptance-test' ]
    - name: Acceptance Test - verify disabled configuration files
      file:
        path: '{{ item }}'
        state: 'absent'
      with_items:
        - '{{ sudo__confd_dir }}/s1_test_disabled'
        - '{{ sudo__confd_dir }}/s1_test_empty'
      register: 'test_result'
      failed_when: (test_result|failed or test_result|changed)
      tags: [ 'acceptance-test' ]
    - name: Acceptance Test - verify unmanaged drop-in configuration files
      copy:
        dest: '{{ sudo__confd_dir }}/s1_sample_file'
        src: 'files/acceptance_tests/t1/s1_sample_file'
      register: 'test_result'
      failed_when: (test_result|failed or test_result|changed)
      tags: [ 'acceptance-test' ]
  roles:
      - role: 'sudo'
        sudo__defaults:
# test boolean default
          - name: 'env_reset'
# test negated boolean default
          - name: '!visiblepw'
# test single string value default
          - name: 'secure_path'
            value: '/sbin:/bin:/usr/sbin:/usr/bin'
# test single int value default
          - name: 'timestamp_timeout'
            value: 30
# test single string value default with spaces
          - name: 'env_keep'
            value: '"LANGUAGE LINGUAS"'
# test multiple value default
          - name: 'env_keep'
            value:
              - 'LANG'
              - 'LC_ALL'
# test single value default exclude
          - name: 'env_keep'
            value: 'LC_IDENTIFICATION'
            exclude: True
# test multiple value default exclude
          - name: 'env_keep'
            value:
              - 'LC_MEASUREMENT'
              - 'LC_MONETARY'
            exclude: True
# test single value default include
          - name: 'env_keep'
            value: 'LC_TIME'
            include: True
# test multiple value default include
          - name: 'env_keep'
            value:
              - 'LANGUAGE'
              - 'LINGUAS'
            include: True
# test multiple value default with single value
          - name: 'timestamp_timeout'
            value:
              - 30
# test empty value default
          - name: 'authenticate'
            value: ''
# test empty list value default
          - name: '!insults'
            value: []
# test value default exclude and include
          - name: 'env_keep'
            value: 'LC_COLLATE'
            exclude: True
            include: True
        sudo__cmnd_aliases:
# test single command alias
          - name: 'CMND_TEST'
            command: '/bin/test'
# test multiple command alias
          - name: 'CMND_TEST_MULTIPLE'
            command:
              - '/bin/test1'
              - '/bin/test2'
              - '/bin/test3'
              - 'CMND_TEST'
        sudo__host_aliases:
# test single host alias
          - name: 'HOST_TEST'
            host: 'test'
# test multiple host alias
          - name: 'HOST_TEST_MULTIPLE'
            host:
              - 'test1'
              - '127.0.0.2'
              - '127.0.0.0/24'
              - '127.0.0.0/255.255.255.0'
              - 'HOST_TEST'
        sudo__runas_aliases:
# test single runas alias
          - name: 'RUNAS_TEST'
            operator: 'test'
# test multiple runas alias
          - name: 'RUNAS_TEST_MULTIPLE'
            operator:
              - 'test1'
              - 'test2'
              - 'test3'
              - 'RUNAS_TEST'
        sudo__user_aliases:
# test single user alias
          - name: 'USER_TEST'
            user: 'test'
# test multiple user alias
          - name: 'USER_TEST_MULTIPLE'
            user:
              - 'test1'
              - 'test2'
              - 'test3'
              - 'USER_TEST'
        sudo__specs:
# test single value specifications
          - name: 's1_test_single_value'
            specs:
# test with all values set
              - user: 'tuser'
                host: 'thost'
                operator: 'toperator'
                tag: 'NOPASSWD'
                command: 'ALL'
# test with only required values set
              - user: 'tuser'
                host: 'thost'
                command: '/bin/test'
# test with required values and optional tag value set
              - user: 'tuser'
                host: 'thost'
                tag: 'NOPASSWD'
                command: '/bin/test'
# test with required values and optional operator value set
              - user: 'tuser'
                host: 'thost'
                operator: 'toperator'
                command: '/bin/test'
# test multiple values specifications
          - name: 's1_test_multiple_values'
            specs:
              - user:
                  - 'tuser1'
                  - 'tuser2'
                  - 'tuser3'
                host:
                  - 'thost1'
                  - 'thost2'
                  - 'thost3'
                operator:
                  - 'toperator1'
                  - 'toperator2'
                  - 'toperator3'
                tag:
                  - 'NOPASSWD'
                  - 'NOEXEC'
                command:
                  - '/bin/test1'
                  - '/bin/test2'
                  - '/bin/test3'
# test standalone defaults in specification file
          - name: 's1_test_defaults'
            defaults:
# test global boolean default
              - name: 'compress_io'
# test global string value default
              - name: 'iolog_dir'
                value: '{{ sudo__iolog_dir }}'
# test user/host/operator/command limited boolean default
              - name: '!authenticate'
                user: 'tuser'
                host: 'thost'
                operator: 'toperator'
                command: '/bin/test'
# test user/host/operator/command limited int default
              - name: 'timestamp_timeout'
                users: 'tuser'
                hosts: 'thost'
                operator: 'toperator'
                command: '/bin/test'
                value: 30
# test multiple user/host/operator/command limited boolean default
              - name: 'insults'
                user:
                  - 'tuser1'
                  - 'tuser2'
                  - 'tuser3'
                host:
                  - 'thost1'
                  - 'thost2'
                  - 'thost3'
                operator:
                  - 'toperator1'
                  - 'toperator2'
                  - 'toperator3'
                command:
                  - '/bin/test1'
                  - '/bin/test2'
                  - '/bin/test3'
# test user limited boolean default
              - name: '!visiblepw'
                user: 'tuser'
# test host limited boolean default
              - name: '!visiblepw'
                host: 'thost'
# test operator limited boolean default
              - name: '!visiblepw'
                operator: 'toperator'
# test command limited boolean default
              - name: '!visiblepw'
                command: '/bin/test'
# test defaults mixed with specifications
          - name: 's1_test_defaults_mixed'
            defaults:
              - name: '!authenticate'
                user: 'tuser'
                host: 'thost'
                operator: 'toperator'
                command: '/bin/test'
              - name: '!visiblepw'
            specs:
              - user: 'tuser'
                host: 'thost'
                operator: 'toperator'
                tag: 'NOPASSWD'
                command: 'ALL'
# test empty definition
          - name: 's1_test_empty'
# test disabled definition
          - name: 's1_test_disabled'
            disabled: True
            defaults:
              - name: '!visiblepw'
# test not disabled definition
          - name: 's1_test_not_disabled'
            disabled: False
            defaults:
              - name: '!visiblepw'
# test example playbook specification
          - name: 's1_test_example_playbook_wheel'
            specs:
              - user: '%wheel'
                host: 'ALL'
                operator: 'ALL'
                command: 'ALL'
